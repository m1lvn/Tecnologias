<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Metas a Largo Plazo</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Crear nueva meta -->
  <ion-card>
    <ion-item>
      <ion-input [(ngModel)]="newMetaTitle" placeholder="Nueva meta..."></ion-input>
      <ion-button slot="end" (click)="addMeta()" fill="solid">Agregar</ion-button>
    </ion-item>

    <!-- Fecha límite (opcional) -->
    <ion-item lines="full" class="deadline-row">
      <ion-label>Fecha límite (opcional)</ion-label>

      <!-- Botón para abrir selector -->
      <ion-datetime-button
        slot="end"
        datetime="deadlinePicker"
        class="deadline-trigger">
      </ion-datetime-button>

      <!-- Mostrar fecha seleccionada -->
      <ion-note slot="end" *ngIf="newMetaDeadline" style="margin-right: 8px;">
        {{ newMetaDeadline | date:'mediumDate' }}
      </ion-note>

      <!-- Botón limpiar -->
      <ion-button slot="end" fill="clear" size="small"
                  (click)="clearDeadline()" *ngIf="newMetaDeadline">
        Limpiar
      </ion-button>
    </ion-item>
  </ion-card>

  <!-- Modal con el selector en modo rueda -->
  <ion-modal keepContentsMounted="true">
    <ion-datetime
      id="deadlinePicker"
      presentation="date"
      preferWheel="true"
      [value]="newMetaDeadline"
      (ionChange)="onDeadlineChange($event)"
      show-default-buttons="true"
      done-text="Listo"
      cancel-text="Cancelar">
    </ion-datetime>
  </ion-modal>

  <!-- Lista de metas -->
  <ion-list>
    <ion-card *ngFor="let meta of metas; let i = index">
      <ion-card-header>
        <ion-card-title>{{ meta.titulo }}</ion-card-title>
        <ion-card-subtitle *ngIf="meta.fechaLimite">
          ⏳ {{ calcularDiasRestantes(meta.fechaLimite) }}
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div>
          {{ contarSubtareasCompletadas(meta) }}/{{ meta.subtareas.length }} completadas
        </div>

        <ion-progress-bar
          [value]="calcularProgreso(meta)"
          color="secondary"
          style="margin: 8px 0;">
        </ion-progress-bar>

        <ion-item lines="none">
          <ion-input [(ngModel)]="meta.nuevaSubtarea" placeholder="Nueva subtarea..."></ion-input>
          <ion-button fill="clear" (click)="addSubtarea(meta)">+</ion-button>
        </ion-item>

        <ion-list>
          <ion-item *ngFor="let sub of meta.subtareas">
            <ion-checkbox slot="start" [(ngModel)]="sub.completada"></ion-checkbox>
            <ion-label>{{ sub.titulo }}</ion-label>
          </ion-item>
        </ion-list>

        <ion-button expand="block" color="danger" (click)="removeMeta(i)">
          Eliminar Meta
        </ion-button>
      </ion-card-content>
    </ion-card>
  </ion-list>
</ion-content>
